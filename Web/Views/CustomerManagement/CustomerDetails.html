<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>客户详情</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>客户列表</title>
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <!-- select2 -->
    <link href="../../plugins/select2/select2.css" rel="stylesheet" />
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <!-- table -->
    <link href="../../dist/css/ovcss.css" rel="stylesheet" />
    <!-- 提示框 -->
    <link href="../../plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <!-- layui 分页 -->
    <link href="../../plugins/layui/css/layui.css" rel="stylesheet" />
    <!--用户管理-->
    <link href="../../dist/css/User_Center.css" rel="stylesheet" />
</head>
<body>
    <!-- 主标题 begin -->
    <div class="ov-tit ov-line rel clearfix">
        <h1 class="ov-theme">客户详情</h1>
    </div>
    <!-- 主标题 end -->
    <div class="Customer_main">
        <div class="line_tit clearfix">
            <p class="lin_p">基本信息</p>
            <div class="edit_fun fr edit_primary"><a class="edit_a edit_info" id="I_edit_info">编辑</a></div>
            <div class="edit_fun fr edit_default"><a class="edit_a default_btn" id="I_default_btn" >取消</a><a class="edit_a primary_btn" id="I_primary_btn" >确定</a></div>
        </div>
        <div class="Info_from">
            <ul class="Info_ul clearfix">
                <li class="Info_li">
                    <span class="Info_span">客户名称：</span><input class="Info_input disabled" id="I_CompanyName" value="" placeholder="客户名称" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">所属行业：</span><input class="Info_input disabled" id="I_Industry" value="" placeholder="所属行业" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">公司规模：</span><input class="Info_input disabled" id="I_CompanySize" value="" placeholder="公司规模" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">成立时间：</span><input class="Info_input disabled" id="I_EstablishedTime" value="" placeholder="成立时间" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">省份：</span><input class="Info_input disabled" id="I_Province" value="" placeholder="省份" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">城市：</span><input class="Info_input disabled" id="I_City" value="" placeholder="城市" />
                </li>
                <li class="Info_li Info_Address">
                    <span class="Info_span">地址：</span><input class="Info_input disabled" id="I_Address" value="" placeholder="地址" />
                </li>
                <li class="Info_li">
                    <span class="Info_span">销售员：</span>
                    <select class="Info_input disabled" id="I_SalesId">
                    </select>
                </li>
                <li class="Info_li">
                    <span class="Info_span">客户来源：</span><input class="disabled" disabled="disabled" id="I_SourceType" value="" />
                </li>
            </ul>
        </div>
    </div>

    <div class="Customer_main">
        <div class="line_tit clearfix">
            <p class="lin_p">联系人</p>
            <div class="edit_fun fr "><a class="edit_a add_Contacts" id="I_add_Contacts">添加联系人</a><a class="edit_a add_Contacts" id="I_add_IsFirst">设为第一联系人</a></div>
        </div>
        <div class="Info_from Info_table">
            <table class="table table-striped table-bordered" id="I_Contacts_table">
                <thead>
                    <tr>
                        <th class="width-chk"></th>
                        <th class="width-datetime">联系人姓名</th>
                        <th class="width-datetime">联系电话</th>
                        <th class="">职位</th>
                        <th class="width-date">微信号</th>
                        <th class="width-date">QQ号</th>
                        <th class="width-datetime">邮箱</th>
                        <th class="width-datetime">操作</th>
                        <th class="width-date">第一联系人</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="Customer_main">
        <div class="line_tit clearfix">
            <p class="lin_p">联系记录</p>
            <div class="edit_fun fr "><a class="edit_a add_Record" id="I_add_Record">添加联系记录</a></div>
        </div>
        <div class="Info_from Info_table">
            <table class="table table-striped table-bordered" id="I_Record_table">
                <thead>
                    <tr>
                        <th class="width-xs">编号</th>
                        <th class="width-datetime">销售员</th>
                        <th class="width-datetime">联系人</th>
                        <th class="width-datetime">联系时间</th>
                        <th class="">联系摘要</th>
                        <th id="Operation_th" class="width-datetime">操作（创建1天内）</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 新增联系人弹层 -->
    <div class="ov-add modal fade I_modal" id="add_Contacts_Modal">
        <div class="modalDialog modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                        <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                    </button>
                    <h4 class="modal-title I_Contacts_title">新增联系人</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-bordered I_Contacts_from">
                        <!-- 填充表单 -->
                    </div>
                </div>
                <div class="modal-footer modal_btn">
                    <button type="button" id="add_Contacts_default" class="btn btn-default">取消</button>
                    <button type="button" id="add_Contacts_primary" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 编辑联系人弹层 -->
    <div class="ov-add modal fade I_modal" id="edit_Contacts_Modal">
        <div class="modalDialog modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                        <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                    </button>
                    <h4 class="modal-title I_Contacts_title">编辑联系人</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-bordered I_edit_Contacts_from">
                        <!-- 填充表单 -->
                    </div>
                </div>
                <div class="modal-footer modal_btn">
                    <button type="button" id="edit_Contacts_default" class="btn btn-default">取消</button>
                    <button type="button" id="edit_Contacts_primary" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增记录弹层 -->
    <div class="ov-add modal fade I_modal" id="add_Record_Modal">
        <div class="modalDialog modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                        <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                    </button>
                    <h4 class="modal-title I_Record_title">新增记录</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-bordered I_Record_from">
                        <!-- 填充表单 -->
                    </div>
                </div>
                <div class="modal-footer modal_btn">
                    <button type="button" id="add_Record_default" class="btn btn-default">取消</button>
                    <button type="button" id="add_Record_primary" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 编辑记录弹层 -->
    <div class="ov-add modal fade I_modal" id="edit_Record_Modal">
        <div class="modalDialog modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                        <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                    </button>
                    <h4 class="modal-title I_Record_title">编辑记录</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-bordered I_edit_Record_from">
                        <!-- 填充表单 -->
                    </div>
                </div>
                <div class="modal-footer modal_btn">
                    <button type="button" id="edit_Record_default" class="btn btn-default">取消</button>
                    <button type="button" id="edit_Record_primary" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jq -->
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <!-- 时间日期插件 -->
    <script src="../../plugins/laydate/laydate.js"></script>
    <!-- bootstrap -->
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- 提示框js -->
    <script src="../../plugins/sweetalert/sweetalert.js"></script>
    <!-- 主标题和筛选 的js -->
    <script src="../../dist/js/form_bow.js"></script>
    <!-- layui 分页js -->
    <script src="../../plugins/layui/layui.js"></script>
    <!-- 拖动js （给需要可拖动弹出层的div 添加 class（modalDialog）即可 ） -->
    <script src="../../dist/js/jquery-ui.js"></script>
    <!-- select2 -->
    <script src="../../plugins/select2/select2.js"></script>

    <script src="../../dist/js/loadovos.js"></script>
    <!-- 公共脚本 -->
    <script src="../../dist/js/common.js"></script>
    <script src="../../dist/js/config.js"></script>
    <script>
        var edit_id = getUrlParam('edit_id');
        var ChannelId = getUrlParam('ChannelId');
        var channelType = getUrlParam('channelType');
        var Jurisdiction = loginInfo.UserType;
        if (Jurisdiction == '3') {
            if (channelType == 1) {
            } else if (channelType == 2) {
                $('.edit_a').remove();
                $('.ov-line').append('<div class="icon_fun abs bot10"><a class="add_right_btn add_Sale_code" onclick="Receive_check();">领取</a></div>')
            } else if (channelType == 3) {
                $('.edit_a').remove();
                $('.ov-line').append('<div class="icon_fun abs bot10"><a class="add_right_btn add_Sale_code" onclick="Reduction_check();">还原</a></div>')
            }
        }
        //获取基本信息
        if (ChannelId) {
            $.ajax({
                type: "GET",
                url: APIS.GetSaleList + '/' + ChannelId,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        var sale_html = '<option value="">--选择销售员跟进--</option><option value="0">客户公海</option>';
                        for (var i = 0; i < items.length; i++) {
                            sale_html += '<option value="' + items[i].Id + '">' + items[i].TrueName + '</option>'
                        }
                        $('#I_SalesId').html(sale_html);
                        if (Jurisdiction == 3) {
                            $('#I_SalesId').val(loginInfo.Id).hide();
                        }
                        get_Info();
                        die_edit();
                    }
                }
            })
        }

        function get_Info() {
            $.ajax({
                type: "GET",
                url: APIS.GetCompanyById + '/' + edit_id,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        $('#I_CompanyName').val(items.CompanyName);
                        $('#I_Industry').val(items.Industry);
                        $('#I_CompanySize').val(items.CompanySize);
                        $('#I_EstablishedTime').val(items.EstablishedTime);
                        $('#I_Province').val(items.Province);
                        $('#I_City').val(items.City)
                        $('#I_Address').val(items.Address);
                        $('#I_SalesId').val(items.SalesId);
                        $('#I_SourceType').val(items.SourceType);
                    }
                }
            });
        }
        SOGDate('I_EstablishedTime');
        //设置禁用
        function die_edit() {
            $('.Info_input').each(function () {
                $(this).attr('disabled', 'disabled').addClass('disabled');
            })
        }
        function pri_edit() {
            $('.Info_input').each(function () {
                $(this).removeAttr('disabled', 'disabled').removeClass('disabled');
            })
            if (Jurisdiction == 3) {
                $('#I_SalesId').addClass('disabled').attr('disabled', 'disabled');
            }
        }
        $('#I_edit_info').on('click', function () {
            pri_edit();
            $('.edit_primary').hide();
            $('.edit_default').show();
            
        })
        $('.default_btn').on('click', function () {
            die_edit();
            $('.edit_default').hide();
            $('.edit_primary').show();
        })
        $('.primary_btn').on('click', function () {
            var CompanyName = $('#I_CompanyName').val();
            var Industry = $('#I_Industry').val();
            var CompanySize = $('#I_CompanySize').val();
            var EstablishedTime = $('#I_EstablishedTime').val();
            var Province = $('#I_Province').val();
            var City = $('#I_City').val()
            var Address = $('#I_Address').val();
            var SalesId = $('#I_SalesId').val();
            $.ajax({
                type: "POST",
                url: APIS.UpdateCompany,
                dataType: "json",
                data: {
                    "CompanyName": CompanyName,
                    "Industry": Industry,
                    "SalesId": SalesId,
                    "CompanySize": CompanySize,
                    "EstablishedTime": EstablishedTime,
                    "Province": Province,
                    "City": City,
                    "Address": Address,
                    "Id": edit_id
                },
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        die_edit();
                        SuccessBox(data.Message);
                        $('.edit_default').hide();
                        $('.edit_primary').show();
                        get_Info();
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            });
            
            
        })

        //联系人
        function Contacts_table() {
            $.ajax({
                type: "get",
                url: APIS.GetCompanyContactListNotPager + '/' + edit_id,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        var type_html = '';
                        for (var i = 0; i < items.length; i++) {
                            type_html += `<tr data-id="${items[i].Id}">
                                            <td><input type="checkbox" data-id="${items[i].Id}" class="SOGCheck"></td>
                                            <td>${items[i].ContactName}</td>
                                            <td>${items[i].ContactPhone}</td>
                                            <td>${items[i].ContactJob}</td>
                                            <td>${items[i].WechatNum}</td>
                                            <td>${items[i].QQNum}</td>
                                            <td>${items[i].Email}</td>
                                            <td><a class ="edit_a edit_Contacts" data-id="${items[i].Id}">编辑</a><a class="edit_a btn_red del_Contacts" data-id="${items[i].Id}">删除</a></td>
                                            <td>${items[i].IsFirst == 1?'是':'否'}</td>
                                        </tr>`
                        }
                        $('#I_Contacts_table tbody').html(type_html);
                    }
                }
            });
        }
        Contacts_table(); //显示联系人列表
        $('#I_add_Contacts').on('click', function () {
            $('.I_Contacts_from').html(`
                                        <div class ="form-group">
                                            <label id="add_lbl_ContactName" class ="col-md-3 control-label">联系人姓名：</label>
                                            <div class ="col-md-8">
                                                <input name="add_ContactName" type="text" value="" rule="/\\S/" id="add_ContactName" class ="form-control Idata" placeholder="联系人姓名">
                                                <label><input type="checkbox" id="add_IsFirst" class ="Contacts_che">企业第一联系人</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="add_lbl_ContactPhone" class ="col-md-3 control-label">联系人号码：</label>
                                            <div class="col-md-8">
                                                <input name="add_ContactPhone" type="text" value="" rule="/^1[3456789]\\d{9}$/" id="add_ContactPhone" class ="form-control Idata" placeholder="联系人号码">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="add_lbl_ContactJob" class ="col-md-3 control-label">联系人职位：</label>
                                            <div class="col-md-8">
                                                <input name="add_ContactJobe"  value="" id="add_ContactJob"  class ="form-control " placeholder="联系人职位">
                                            </div>
                                        </div>
                                      
                                        <div class ="form-group">
                                            <label id="add_lbl_WechatNum" class ="col-md-3 control-label">微信号：</label>
                                            <div class ="col-md-8">
                                                <input name="add_WechatNum" " value="" id="add_WechatNum"  class ="form-control " placeholder="微信号">
                                            </div>
                                        </div>
                                        <div class ="form-group">
                                            <label id="add_lbl_QQNum" class ="col-md-3 control-label">QQ号：</label>
                                            <div class ="col-md-8">
                                                <input name="add_QQNum" value="" id="add_QQNum"  class ="form-control " placeholder="QQ号">
                                            </div>
                                        </div>
                                         <div class ="form-group">
                                            <label id="add_lbl_Email" class ="col-md-3 control-label">邮箱：</label>
                                            <div class ="col-md-8">
                                                <input name="add_Email" value="" id="add_Email"  class ="form-control " placeholder="邮箱">
                                            </div>
                                        </div>
                                         <div class ="form-group">
                                            <label id="add_lbl_IdCard" class ="col-md-3 control-label">身份证：</label>
                                            <div class ="col-md-8">
                                                <input name="add_IdCard" value="" id="add_IdCard"  class ="form-control " placeholder="身份证">
                                            </div>
                                        </div>
                                        `);
            
            ShowUI('add_Contacts_Modal');
        })
        $("#add_Contacts_default").on('click', function () {
            HideUI('add_Contacts_Modal');
        })
        $("#add_Contacts_primary").on('click', function () {
            if (required('add_Contacts_Modal')) { //验证
                return false;
            }
            var ContactName = $('#add_ContactName').val();//联系人姓名
            var ContactPhone = $('#add_ContactPhone').val();//联系人电话
            var ContactJob = $('#add_ContactJob').val();//联系人职位
            var WechatNum = $('#add_WechatNum').val();//微信号
            var QQNum = $('#add_QQNum').val();//qq号
            var Email = $('#add_Email').val()//邮箱
            var IdCard = $('#add_IdCard').val();//身份证 
            var CId = edit_id;//客户表id（公司Id） 
            var IsFirst = $('#add_IsFirst').prop("checked") == true ? '1' : '0';//是否第一联系人
            $.ajax({
                type: "POST",
                url: APIS.AddCompanyContact,
                dataType: "json",
                data: {
                    "ContactName": ContactName,
                    "ContactPhone": ContactPhone,
                    "ContactJob": ContactJob,
                    "WechatNum": WechatNum,
                    "QQNum": QQNum,
                    "Email": Email,
                    "IdCard": IdCard,
                    "CId": CId,
                    "IsFirst": IsFirst
                },
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        Contacts_table();
                        HideUI('add_Contacts_Modal');
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            }); 
            
        })
        $('body').on('click', '.SOGCheck', function () {
            $('.SOGCheck').attr('checked', false);
            $(this).prop('checked', true);
        })
        //设为第一联系人
        $('body').on('click', '#I_add_IsFirst', function () {
            var C_id = $('.SOGCheck:checked').attr('data-id');
            if ($('.SOGCheck:checked').length>0){
                $.ajax({
                    type: "POST",
                    url: APIS.SetFirstContact + '/' + C_id,
                    dataType: "json",
                    success: function (result) {
                        var data = result;
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                            Contacts_table();
                            HideUI('add_Contacts_Modal');
                        } else {
                            ErrorBox(data.Message);
                        }
                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        ErrorBox('当前网络较差，请刷新重试');
                    }
                });
            } else {
                ErrorBox('请勾选需要设为第一联系人的按钮');
            }
        })

        //编辑
        $('body').on('click', '.edit_Contacts', function () {
            var C_id = $(this).attr('data-id');
            $.ajax({
                type: "get",
                url: APIS.GetCompanyContactById + '/' + C_id,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        $('.I_edit_Contacts_from').html(`
                            <input class ="hide" hidden="hidden" id="edit_id" value="${items.Id}">
                                        <div class ="form-group">
                                            <label id="edit_lbl_ContactName" class ="col-md-3 control-label">联系人姓名：</label>
                                            <div class ="col-md-8">
                                                <input name="edit_ContactName" type="text" value="${items.ContactName}" rule="/\\S/" id="edit_ContactName" class ="form-control Idata" placeholder="联系人姓名">
                                                <label><input type="checkbox" id="edit_IsFirst" class ="Contacts_che" ${items.IsFirst == 1 ?'checked="checked"':''} >企业第一联系人</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="edit_lbl_ContactPhone" class ="col-md-3 control-label">联系人号码：</label>
                                            <div class="col-md-8">
                                                <input name="edit_ContactPhone" type="text" value="${items.ContactPhone}" rule="/^1[3456789]\\d{9}$/" id="edit_ContactPhone" class ="form-control Idata" placeholder="联系人号码">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="edit_lbl_ContactJob" class ="col-md-3 control-label">联系人职位：</label>
                                            <div class="col-md-8">
                                                <input name="edit_ContactJobe"  value="${items.ContactJob}" id="edit_ContactJob"  class ="form-control " placeholder="联系人职位">
                                            </div>
                                        </div>

                                        <div class ="form-group">
                                            <label id="edit_lbl_WechatNum" class ="col-md-3 control-label">微信号：</label>
                                            <div class ="col-md-8">
                                                <input name="edit_WechatNum" " value="${items.WechatNum}" id="edit_WechatNum"  class ="form-control " placeholder="微信号">
                                            </div>
                                        </div>
                                        <div class ="form-group">
                                            <label id="edit_lbl_QQNum" class ="col-md-3 control-label">QQ号：</label>
                                            <div class ="col-md-8">
                                                <input name="edit_QQNum" value="${items.QQNum}" id="edit_QQNum"  class ="form-control " placeholder="QQ号">
                                            </div>
                                        </div>
                                         <div class ="form-group">
                                            <label id="edit_lbl_Email" class ="col-md-3 control-label">邮箱：</label>
                                            <div class ="col-md-8">
                                                <input name="edit_Email" value="${items.Email}" id="edit_Email"  class ="form-control " placeholder="邮箱">
                                            </div>
                                        </div>
                                         <div class ="form-group">
                                            <label id="edit_lbl_IdCard" class ="col-md-3 control-label">身份证：</label>
                                            <div class ="col-md-8">
                                                <input name="edit_IdCard" value="${items.IdCard}" id="edit_IdCard"  class ="form-control " placeholder="身份证">
                                            </div>
                                        </div>
                                        `);
                        ShowUI('edit_Contacts_Modal');

                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            });
           
        })
        $('#edit_Contacts_default').on('click', function () {
            HideUI('edit_Contacts_Modal');
        })
        $('#edit_Contacts_primary').on('click', function () {
            if (required('edit_Contacts_Modal')) { //验证
                return false;
            }
            var ContactName = $('#edit_ContactName').val();//联系人姓名
            var ContactPhone = $('#edit_ContactPhone').val();//联系人电话
            var ContactJob = $('#edit_ContactJob').val();//联系人职位
            var WechatNum = $('#edit_WechatNum').val();//微信号
            var QQNum = $('#edit_QQNum').val();//qq号
            var Email = $('#edit_Email').val()//邮箱
            var IdCard = $('#edit_IdCard').val();//身份证 
            var CId = edit_id;//客户表id（公司Id） 
            var IsFirst = $('#edit_IsFirst').prop("checked") == true ? '1' : '0';//是否第一联系人
            var Id = $('#edit_id').val();
            $.ajax({
                type: "POST",
                url: APIS.UpdateCompanyContact,
                dataType: "json",
                data: {
                    "ContactName": ContactName,
                    "ContactPhone": ContactPhone,
                    "ContactJob": ContactJob,
                    "WechatNum": WechatNum,
                    "QQNum": QQNum,
                    "Email": Email,
                    "IdCard": IdCard,
                    "CId": CId,
                    "IsFirst": IsFirst,
                    "Id": Id
                },
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        Contacts_table();
                        HideUI('edit_Contacts_Modal'); 
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            }); 
           
        })

        $("body").on('click', '.del_Contacts', function () {
            var _this = $(this);
            var del_data = _this.attr('data-id');
            var r = confirm("确定删除？")
            if (r == true) {
                showLoad();
                $.ajax({
                    type: 'POST',
                    url: APIS.DeleteCompanyContact + '/' + del_data,
                    dataType: "json",
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                            Contacts_table();
                        } else {
                            ErrorBox(data.Message);
                        }
                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                        ErrorBox('当前网络较差，请刷新重试');
                    }
                })
            }
        })

        //联系记录
        // 表格数据
        var currentPage = 1; //当前页数
        var page_first = 0; //第一次获取列表数据
        var page_count = 0; //总条数
        function Record_table() {
            var companyName = $('#I_CompanyName').val();
            var pageSize = 10;  //每页显示的条数
            var pageIndex = currentPage;
            if(Jurisdiction == '3'){
                $('#Operation_th').hide();
            }
            showLoad();
            $.ajax({
                type: "get",
                url: APIS.GetCompanyRecordList,
                dataType: "json",
                data: {
                    'companyName': companyName,
                    'pageSize': pageSize,
                    'pageIndex': pageIndex
                },
                success: function (result) {
                    hideLoad();
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData.CompanyRecordList;
                        page_count = data.AppendData.TotalCount; //总条数
                        var type_html = '';
                        for (var i = 0; i < items.length; i++) {
                            type_html += `
                                        <tr data-id="${items[i].Id}">
                                            <td>${items[i].RowNum}</td>
                                            <td>${items[i].TrueName}</td>
                                            <td>${items[i].ContactName}</td>
                                            <td>${items[i].ContactTime}</td>
                                            <td>${items[i].ContactSummary}</td>
                                            <td ${Jurisdiction == '3'?'style="display:none"':''}><a class ="edit_a  ${items[i].IsAction == 1 ? 'edit_Record' : 'modal_Nodel'}" data-id="${items[i].Id}" ${items[i].IsAction == 1 ? '': 'title="' +items[i].DisplayName +'"'}>编辑</a><a class="edit_a btn_red  ${items[i].IsAction == 1 ? 'del_Record' : 'modal_Nodel'} " ${items[i].IsAction == 1 ? '' : 'title="' + items[i].DisplayName +'"'} data-id="${items[i].Id}">删除</a></td>
                                        </tr>
                                        `
                        }
                        $('#I_Record_table tbody').html(type_html);
                        laypage_up(page_count);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            });
        }

        //初始数据
        try {
            Record_table()//获取初始表数据
        } catch (err) {
        }
        
        //分页
        function laypage_up() {
            layui.use(['laypage', 'layer'], function () {
                var laypage = layui.laypage
                , layer = layui.layer;
                laypage.render({
                    elem: 'layui_page'
                    , count: page_count
                    , limit: 10
                    , curr: currentPage || 1
                    , layout: ['count', 'prev', 'page', 'next', 'skip']
                    , jump: function (obj, first) {
                        currentPage = obj.curr;
                        if (!first) {//首次不执行
                            Record_table();

                        }

                    }
                });
            })
        }

        $('#I_add_Record').on('click', function () {
            var SalesId = $('#I_SalesId').val();
            $('.I_Record_from').html(`<div class ="form-group">
                                            <label id="add_lbl_ContactId" class ="col-md-3 control-label">联系人姓名：</label>
                                            <div class ="col-md-8">
                                                <select class ="form-control" id="add_ContactId">
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="add_lbl_ContactTime" class ="col-md-3 control-label">联系时间：</label>
                                            <div class="col-md-8">
                                                <input name="add_ContactTime"  value="" id="add_ContactTime" class ="form-control Idata" placeholder="联系时间">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="add_lbl_ContactSummary" class ="col-md-3 control-label">联系摘要：</label>
                                            <div class="col-md-8">
                                                <textarea id="add_ContactSummary"  class ="form-control " placeholder="联系摘要"></textarea>
                                            </div>
                                        </div>
                                        <input class ="hide" hidden="hidden" value="${SalesId}" id="add_SalesId" placeholder="销售员id">`);
            SOGDateTime('add_ContactTime');
            $.ajax({
                type: "get",
                url: APIS.GetCompanyContactListNotPager + '/' + edit_id,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        var type_html = '<option value="">--选择联系人--</option>';
                        for (var i = 0; i < items.length; i++) {
                            type_html += `<option value='${items[i].Id}'>${items[i].ContactName}</option>`
                        }
                        $('#add_ContactId').html(type_html);
                    }
                }
            });
            ShowUI('add_Record_Modal');
        })
        $("#add_Record_default").on('click', function () {
            HideUI('add_Record_Modal');
        })
        $("#add_Record_primary").on('click', function () {
            if (required('add_Record_Modal')) { //验证
                return false;
            }
            var ContactId = $('#add_ContactId').val();//联系人id
            var ContactTime = $('#add_ContactTime').val();//联系时间
            var ContactSummary = $('#add_ContactSummary').val();//联系摘要
            var SalesId = $('#add_SalesId').val();//销售员id
            $.ajax({
                type: "POST",
                url: APIS.AddComapnyRecord,
                dataType: "json",
                data: {
                    "ContactId": ContactId,
                    "ContactTime": ContactTime,
                    "ContactSummary": ContactSummary,
                    "SalesId": SalesId,
                },
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        Record_table();
                        HideUI('add_Record_Modal');
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            });
        })

        //编辑
        $('body').on('click', '.edit_Record', function () {
            var C_id = $(this).attr('data-id');
            $.ajax({
                type: "get",
                url: APIS.GetCompanyRecordById + '/' + C_id,
                dataType: "json",
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        var items = data.AppendData;
                        var SalesId = $('#I_SalesId').val();
                        $('.I_edit_Record_from').html(`
                                        <input value="${items.Id}" class ="hide" hidden="hidden" id="edit_Record_id" />
                                        <div class ="form-group">
                                            <label id="edit_lbl_ContactId" class="col-md-3 control-label">联系人方式：</label>
                                            <div class ="col-md-8">
                                                <input class ="form-control" value="${items.DisplayName}" disabled="disabled" id="edit_ContactId" />
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label id="edit_lbl_ContactSummary" class="col-md-3 control-label">联系摘要：</label>
                                            <div class="col-md-8">
                                                <textarea id="edit_ContactSummary"  class="form-control" placeholder="联系摘要">${items.ContactSummary}</textarea>
                                            </div>
                                        </div>
                                        `);
                        ShowUI('edit_Record_Modal');
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            });

        })
        $('#edit_Record_default').on('click', function () {
            HideUI('edit_Record_Modal');
        })
        $('#edit_Record_primary').on('click', function () {
            if (required('edit_Record_Modal')) { //验证
                return false;
            }
            var Id = $('#edit_Record_id').val();
            var ContactSummary = $('#edit_ContactSummary').val();
            $.ajax({
                type: "POST",
                url: APIS.UpdateComapnyRecord,
                dataType: "json",
                data: {
                    "Id": Id,
                    "ContactSummary": ContactSummary
                },
                success: function (result) {
                    var data = result;
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        Record_table();
                        HideUI('edit_Record_Modal');
                    } else {
                        ErrorBox(data.Message);
                    }
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    ErrorBox('当前网络较差，请刷新重试');
                }
            });

        })

        $("body").on('click', '.del_Record', function () {
            var _this = $(this);
            var del_data = _this.attr('data-id');
            var r = confirm("确定删除？")
            if (r == true) {
                showLoad();
                $.ajax({
                    type: 'POST',
                    url: APIS.DeleteCompanyRecord + '/' + del_data,
                    dataType: "json",
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                            Record_table();
                        } else {
                            ErrorBox(data.Message);
                        }
                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                        ErrorBox('当前网络较差，请刷新重试');
                    }
                })
            }
        })

        //领取客户
        function Receive_check() {
                var departmentIds = []; //需移动的id的集合
                var del_data = edit_id;
                departmentIds.push(del_data);
                var radio_val = loginInfo.Id; //销售员id
                showLoad();
                $.ajax({
                    type: 'POST',
                    url: APIS.ToggleOutPublic,
                    dataType: "json",
                    data: {
                        'Ids': departmentIds,
                        'SalesId': radio_val
                    },
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                        } else {
                            ErrorBox(data.Message);
                        }
                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                        ErrorBox('当前网络较差，请刷新重试');
                    }
                })
        }
        //还原客户
        function Reduction_check() {
                var departmentIds = []; //需移动的id的集合
                var del_data = edit_id;
                departmentIds.push(del_data);
                var radio_val = loginInfo.Id; //销售员id
                showLoad();
                $.ajax({
                    type: 'POST',
                    url: APIS.ToggleOutRecycle,
                    dataType: "json",
                    data: {
                        'Ids': departmentIds,
                        'SalesId': radio_val
                    },
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                        } else {
                            ErrorBox(data.Message);
                        }
                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                        ErrorBox('当前网络较差，请刷新重试');
                    }
                })
        }

    </script>
</body>
</html>
