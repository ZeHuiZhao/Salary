
@{
    ViewBag.Title = "菜单列表";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



@section customStyle{
    <style type="text/css">
        .btn_channel {
            margin: 0px 3px 0px 3px;
        }
    </style>
}

<!-- 主标题 begin -->
<div class="ov-tit ov-line rel clearfix">
    <h1 class="ov-theme">菜单列表</h1>
    <div class="icon_fun abs bot10">
        <span class="glyphicon glyphicon-plus iconfont icon_add " id="add_function" title="新增功能"></span>
    </div>
</div>
<!-- 主标题 end -->
<!-- 内容表格 begin -->
<div class="ov-form table-responsive I_department_form">
    <table class="table table-striped table-bordered" id="gv_data">
        <thead>
        </thead>
        <tbody>
            <tr>
                <th>功能名称</th>
                <th>URL</th>
                <th>父功能名称</th>
                <th>顺序</th>
                <th>图标</th>
                <th class="width-lg">操作</th>
            </tr>
        </tbody>
    </table>
</div>
<!-- 内容表格 end -->
<!--新增弹层-->
<div class="ov-add modal fade I_modal" id="add_box">
    <div class="modalDialog modal-dialog  ui-draggable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                    <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                </button>
                <h4 class="modal-title I_increase_title">新增功能</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal form-bordered I_increase_from">
                    <div class="form-group">
                        <label id="add_lbl_parentid" class="col-md-3 control-label">父级菜单</label>
                        <div class="col-md-8">
                            <select value="" id="add_parentid" class="form-control Idata" placeholder="父级菜单"></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_FunctionName" class="col-md-3 control-label">功能名称</label>
                        <div class="col-md-8">
                            <input type="text" value="" rule="/\S/" id="add_FunctionName" class="form-control Idata" placeholder="功能名称">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_URL" class="col-md-3 control-label">URL</label>
                        <div class="col-md-8">
                            <input type="text" value=""  id="add_URL" class="form-control Idata" placeholder="URL">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_Order" class="col-md-3 control-label">顺序</label>
                        <div class="col-md-8">
                            <input type="text" value="" rule="/\S/" id="add_Order" class="form-control Idata" placeholder="顺序">
                        </div>
                    </div>

                    <div class="form-group">
                            <label id="add_lbl_Ico" class="col-md-3 control-label">图标</label>
                            <div class="col-md-8">
                                <input type="text" value=""  id="add_Ico" class="form-control Idata" placeholder="图标">
                            </div>
                        </div>

                    @*<div class="form-group clearfix">
                        <label id="add_lbl_Ico" class="col-md-3 control-label align-right">上传图片</label>
                        <div class="col-md-8">
                            <input name="add_Img" type="file" id="add_Ico" />
                            <input name="save_Img" class="hide" type="text" id="I_save_Img" />
                        </div>
                    </div>*@
                </div>
                <div class="modal-footer modal_btn">
                    <button type="button" id="btn_add_cancel" class="btn btn-default">取消</button>
                    <button type="button" id="btn_add_save" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!--编辑弹层-->
    <div class="ov-add modal fade I_modal" id="edit_box">
        <div class="modalDialog modal-dialog  ui-draggable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                        <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                    </button>
                    <h4 class="modal-title I_increase_title">编辑功能</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-bordered I_increase_from">
                        <div class="form-group">
                            <label id="edit_lbl_parentid" class="col-md-3 control-label">父级菜单</label>
                            <div class="col-md-8">
                                <select value="" id="edit_parentid" class="form-control Idata" placeholder="父级菜单"></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="edit_lbl_FunctionName" class="col-md-3 control-label">功能名称</label>
                            <div class="col-md-8">
                                <input type="text" value="" rule="/\S/" id="edit_FunctionName" class="form-control Idata" placeholder="功能名称">
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="edit_lbl_URL" class="col-md-3 control-label">URL</label>
                            <div class="col-md-8">
                                <input type="text" value="" id="edit_URL" class="form-control Idata" placeholder="URL">
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="edit_lbl_Order" class="col-md-3 control-label">顺序</label>
                            <div class="col-md-8">
                                <input type="text" value="" rule="/\S/" id="edit_Order" class="form-control Idata" placeholder="顺序">
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="edit_lbl_Ico" class="col-md-3 control-label">图标</label>
                            <div class="col-md-8">
                                <input type="text" value="" id="edit_Ico" class="form-control Idata" placeholder="图标">
                            </div>
                        </div>
                     
                    </div>
                </div>
                <div class="modal-footer modal_btn">
                    <input type="hidden" id="hidden_id" />
                    <button type="button" id="btn_edit_cancel" class="btn btn-default">取消</button>
                    <button type="button" id="btn_edit_save" class="btn btn-primary ">确定</button>
                </div>
            </div>
        </div>
    </div>
        
    @section customScript{
        <script type="text/javascript">
            var editID = "";
            var delID = "";

            //新增  弹窗
            $("#add_function").click(function () {
                ShowUI('add_box');
            });

            //新增  取消
            $("#btn_add_cancel").click(function () {
                HideUI('add_box');
            });

            //新增  保存
            $("#btn_add_save").click(function () {
                if (required('add_box')) { //验证
                    return false;
                }
                showLoad();

                var ParentId = $("#add_parentid").val();
                var Name = $("#add_FunctionName").val();
                var URL = $("#add_URL").val();
                var Ico = $("#add_Ico").val();
                var Order = $("#add_Order").val();

                $.ajax({
                    type: "post",
                    url: "/Setting/AddFunction",
                    data: { 'ParentId': ParentId, 'Name': Name, 'URL': URL, 'Ico': Ico, 'Order': Order },
                    dataType: "json",
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                            HideUI('add_box');
                            $("#add_parentid").val("");
                            $("#add_FunctionName").val("");
                            $("#add_URL").val("");
                            $("#add_Ico").val("");
                            $("#add_Order").val("");
                            FunctionList();
                            GetAddfunctionName();
                            GetEditfunctionName();
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                    }
                })
            })

            // 新增 绑定功能名称
            function GetAddfunctionName() {
                $.ajax({
                    type: "post",
                    url: "/Setting/GetFunctionName",
                    dataType: "json",
                    success: function (data) {
                        if (data.ResultType == 200) {                          
                            var add_parentid = $("#add_parentid");
                            add_parentid.empty();
                            add_parentid.append('<option></option>');
                            for (var i = 0; i < data.AppendData.length; i++) {
                                var row = data.AppendData[i];
                                add_parentid.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                            }
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                    }
                })
            }
            GetAddfunctionName();

            // 编辑 绑定功能名称
            function GetEditfunctionName() {
                $.ajax({
                    type: "post",
                    url: "/Setting/GetFunctionName",
                    dataType: "json",
                    success: function (data) {
                        if (data.ResultType == 200) {
                            var edit_parentid = $("#edit_parentid");
                            edit_parentid.empty();
                            edit_parentid.append('<option></option>');
                            for (var i = 0; i < data.AppendData.length; i++) {
                                var row = data.AppendData[i];
                                edit_parentid.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                            }
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                    }
                })
            }
            GetEditfunctionName();

            //功能列表
            function FunctionList() {
                showLoad();
                $.ajax({
                    type: 'post',
                    url: "/Setting/GetFunctionList",
                    dataType: "json",
                    success: function (data) {
                        hideLoad();
                        $(".rl").empty();
                        if (data.ResultType == 200) {
                            for (var i = 0; i < data.AppendData.length; i++) {
                                var row = data.AppendData[i];
                                $("#gv_data").append('<tr class="rl" id=' + row.Id + '><td>' + row.Name + '</td><td>' + row.URL + '</td><td>' + row.ParentId + '</td><td>' + row.Order + '</td><td>' + row.Ico + '</td><td><a class="btn_channel Reset_edit modal_edit edit" data-id=' + row.Id + '>编辑</a><a class="btn_channel Reset_remove del" data-id=' + row.Id + '>删除</a></td></tr>');
                            }
                            GetOne();
                            DelOne();
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                        ErrorBox('暂无数据内容');
                    }
                })

            }
            FunctionList();

            //点击编辑按钮,获取一条信息
            function GetOne() {
                $(".modal_edit").click(function () {
                    editID = $(this).attr("data-id");
                    $("#hidden_id").val(editID);
                    $.ajax({
                        type: 'post',
                        url: "/Setting/GetOneFunction/" + editID,
                        dataType: "json",
                        success: function (data) {
                            if (data.ResultType == 200) {
                                var row = data.AppendData;
                                $("#edit_parentid").val(row.ParentId);
                                $("#edit_FunctionName").val(row.Name);
                                $("#edit_URL").val(row.URL);
                                $("#edit_Ico").val(row.Ico);
                                $("#edit_Order").val(row.Order);
                                ShowUI('edit_box');
                            }
                            else {
                                ErrorBox(data.Message);
                            }

                        }
                    })
                })
            };

            //编辑 取消
            $("#btn_edit_cancel").click(function () {
                HideUI('edit_box');
            });

            //编辑  保存
            $("#btn_edit_save").click(function () {
                if (required('edit_box')) { //验证
                    return false;
                }
                showLoad();

                var ParentId = $("#edit_parentid").val();
                var Name = $("#edit_FunctionName").val();
                var URL = $("#edit_URL").val();
                var Ico = $("#edit_Ico").val();
                var Order = $("#edit_Order").val();
                var id = $("#hidden_id").val();
                $.ajax({
                    type: "post",
                    url: "/Setting/UpdateFunction/" + id,
                    data: { 'ParentId': ParentId, 'Name': Name, 'URL': URL, 'Ico': Ico, 'Order': Order },
                    dataType: "json",
                    success: function (data) {
                        hideLoad();
                        if (data.ResultType == 200) {
                            SuccessBox(data.Message);
                            FunctionList();
                            HideUI('edit_box');
                            GetAddfunctionName();
                            GetEditfunctionName();
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        hideLoad();
                    }
                })
            });

            //删除
            function DelOne() {
                $(".Reset_remove").click(function () {
                    delID = $(this).attr("data-id");
                    var r = confirm("确定删除？")

                    if (r == true) {
                        showLoad();
                        $.ajax({
                            type: "post",
                            url: "/Setting/DelFunction/" + delID,
                            dataType: "json",
                            success: function (data) {
                                hideLoad();
                                if (data.ResultType == 200) {
                                    SuccessBox(data.Message);
                                    FunctionList();
                                    GetAddfunctionName();
                                    GetEditfunctionName();
                                }
                                else {
                                    ErrorBox(data.Message);
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                hideLoad();
                            }
                        })
                    }
                })
            };

        </script>
    }
