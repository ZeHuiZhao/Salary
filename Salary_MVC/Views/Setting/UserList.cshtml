
@{
    ViewBag.Title = "用户管理";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section customStyle{
    <style type="text/css">
        .btn_channel {
            margin: 0px 3px 0px 3px;
        }
    </style>

}

<!-- 主标题 begin -->
<div class="ov-tit ov-line rel clearfix">
    <h1 class="ov-theme">用户管理</h1>
    <div class="icon_fun abs bot10">
        <span class="glyphicon glyphicon-plus iconfont icon_add " id="add_user" title="新增用户"></span>
    </div>
</div>
<!-- 主标题 end -->
<!-- 内容表格 begin -->
<div class="ov-form table-responsive I_department_form">
    <!-- 表格数据 -->
    <table class="table table-striped table-bordered" id="gv_data">
        <thead>
        </thead>
        <tbody>
            <tr>
                <th class="width-chk"><input type="checkbox" /></th>
                <th class="width-md">用户名</th>
                <th>姓名</th>
                <th>角色</th>
                <th>权限组</th>
                <th class="width-lg">操作</th>
            </tr>

            @*<tr id="">
                    <td>
                        <input type="checkbox" />
                    </td>
                    <td>13430380816</td>
                    <td>赵泽辉</td>
                    <td></td>
                    <td></td>
                    <td>
                        <a class="btn_channel Reset_edit modal_edit edit" data-id="578">编辑</a>
                        <a class="btn_channel Reset_edit set" data-id="578">设置权限</a>
                        <a class="btn_channel Reset_remove del" data-id="578">删除</a>
                    </td>
                </tr>*@
        </tbody>
    </table>
</div>
<!-- 内容表格 end -->
<!--新增弹层-->
<div class="ov-add modal fade I_modal" id="add_box">
    <div class="modalDialog modal-dialog  ui-draggable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                    <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                </button>
                <h4 class="modal-title I_increase_title">添加用户信息</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal form-bordered I_increase_from">
                    <div class="form-group">
                        <label id="add_lbl_TypeName" class="col-md-3 control-label">用户名</label>
                        <div class="col-md-8">
                            <input name="add_TypeName" type="text" value="" rule="/\S/" id="add_account" class="form-control Idata" placeholder="用户名">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_TypeName" class="col-md-3 control-label">姓名</label>
                        <div class="col-md-8">
                            <input name="add_TypeName" type="text" value="" rule="/\S/" id="add_name" class="form-control Idata" placeholder="姓名">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_TypeName" class="col-md-3 control-label">密码</label>
                        <div class="col-md-8">
                            <input name="add_TypeName" type="password" value="" rule="/\S/" id="add_pwd" class="form-control Idata" placeholder="密码">
                        </div>
                    </div>

                    @*<div class="form-group">
                            <label id="add_lbl_TypeName" class="col-md-3 control-label">角色</label>
                            <div class="col-md-8">
                                <select id="add_role" rule="/\S/" class="form-control Idata">
                                </select>
                            </div>
                        </div>*@

                    <!-- 多选 SOGMitiSelect -->
                    <div class="form-group">
                        <label class="col-md-3 control-label ">角色</label>
                        <div class="col-md-8">
                            <select id="add_role" rule="/\S/" class="js-example-basic-multiple SOGMitiSelect" multiple></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="add_lbl_TypeName" class="col-md-3 control-label">功能组</label>
                        <div class="col-md-8">
                            <select id="add_FunctionGroup" rule="/\S/" class="form-control Idata">
                            </select>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer modal_btn">
                <button type="button" id="btn_add_cancel" class="btn btn-default">取消</button>
                <button type="button" id="btn_add_save" class="btn btn-primary ">确定</button>
            </div>
        </div>
    </div>
</div>

<!--编辑弹层-->
<div class="ov-add modal fade I_modal" id="edit_box">
    <div class="modalDialog modal-dialog  ui-draggable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close modal_close" data-dismiss="modal" aria-label="Close">
                    <i class="glyphicon glyphicon-remove-sign modal_close_i"></i>
                </button>
                <h4 class="modal-title I_increase_title">编辑用户信息</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal form-bordered I_increase_from">
                    <div class="form-group">
                        <label id="edit_lbl_TypeName" class="col-md-3 control-label">用户名</label>
                        <div class="col-md-8">
                            <input type="text" value="" rule="/\S/" id="edit_account" class="form-control Idata" placeholder="用户名">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="edit_lbl_TypeName" class="col-md-3 control-label">姓名</label>
                        <div class="col-md-8">
                            <input type="text" value="" rule="/\S/" id="edit_name" class="form-control Idata" placeholder="姓名">
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="edit_lbl_TypeName" class="col-md-3 control-label">密码</label>
                        <div class="col-md-8">
                            <input type="password" value="" rule="/\S/" id="edit_pwd" class="form-control Idata" placeholder="密码">
                        </div>
                    </div>

                    @*<div class="form-group">
                            <label id="edit_lbl_TypeName" class="col-md-3 control-label">角色</label>
                            <div class="col-md-8">
                                <select id="edit_role" rule="/\S/" class="form-control Idata">
                                    <option>HR</option>
                                    <option>会计</option>
                                </select>
                            </div>
                        </div>*@

                    <!-- 多选 SOGMitiSelect -->
                    <div class="form-group">
                        <label class="col-md-3 control-label ">角色</label>
                        <div class="col-md-8">
                            <select id="edit_role"   class="js-example-basic-multiple SOGMitiSelect" multiple></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="edit_lbl_TypeName" class="col-md-3 control-label">功能组</label>
                        <div class="col-md-8">
                            <select id="edit_FunctionGroup" rule="/\S/" class="form-control Idata">
                                @*<option>考勤组</option>*@
                            </select>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer modal_btn">
                <input type="hidden" id="hidden_id" />
                <button type="button" id="btn_edit_cancel" class="btn btn-default">取消</button>
                <button type="button" id="btn_edit_save" class="btn btn-primary ">确定</button>
            </div>
        </div>
    </div>
</div>


@section customScript{
    <script>
        $(".SOGMitiSelect").select2({
            placeholder: "请至少选择一个",
            tags: true,
            createTag: function (decorated, params) {
                return null;
            },
            width: '100%'
        });

        //新增  绑定角色
        function GetAddRole() {
            $.ajax({
                type: "post",
                url: "/Setting/GetRoleName",
                dataType: "json",
                success: function (data) {
                    if (data.ResultType == 200) {
                        var add_role = $("#add_role");
                        add_role.empty();
                        add_role.append('<option></option>');
                        for (var i = 0; i < data.AppendData.length; i++) {
                            var row = data.AppendData[i];
                            add_role.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                        }
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        }
        GetAddRole();

        //编辑  绑定角色
        function GetEditRole() {
            $.ajax({
                type: "post",
                url: "/Setting/GetRoleName",
                dataType: "json",
                success: function (data) {
                    if (data.ResultType == 200) {
                        var edit_role = $("#edit_role");
                        edit_role.empty();
                        edit_role.append('<option></option>');
                        for (var i = 0; i < data.AppendData.length; i++) {
                            var row = data.AppendData[i];
                            edit_role.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                        }
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        }
        GetEditRole();

        //新增  绑定功能组
        function GetAddFunctionGroup() {
            $.ajax({
                type: "post",
                url: "/Setting/GetFunctionGroup",
                dataType: "json",
                success: function (data) {
                    if (data.ResultType == 200) {
                        var add_FunctionGroup = $("#add_FunctionGroup");
                        add_FunctionGroup.empty();
                        add_FunctionGroup.append('<option></option>');
                        for (var i = 0; i < data.AppendData.length; i++) {
                            var row = data.AppendData[i];
                            add_FunctionGroup.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                        }
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        }
        GetAddFunctionGroup();

        //编辑 绑定功能组
        function GetEditFunctionGroup() {
            $.ajax({
                type: "post",
                url: "/Setting/GetFunctionGroup",
                dataType: "json",
                success: function (data) {
                    if (data.ResultType == 200) {
                        var edit_FunctionGroup = $("#edit_FunctionGroup");
                        edit_FunctionGroup.empty();
                        edit_FunctionGroup.append('<option></option>');
                        for (var i = 0; i < data.AppendData.length; i++) {
                            var row = data.AppendData[i];
                            edit_FunctionGroup.append('<option value=' + row.Id + '>' + row.Name + '</option>');
                        }
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        }
        GetEditFunctionGroup();

        //新增 弹窗
        $("#add_user").click(function () {
            ShowUI('add_box');
        });

        //新增 取消
        $("#btn_add_cancel").click(function () {
            HideUI('add_box');
        });

        //编辑 取消
        $("#btn_edit_cancel").click(function () {
            HideUI('edit_box');
        });

        //新增  保存
        $("#btn_add_save").click(function () {
            if (required('add_box')) { //验证
                return false;
            }
            //showLoad();

            var UserName = $("#add_account").val();
            var Name = $("#add_name").val();
            var Password = $("#add_pwd").val();
            var Role = $("#add_role").val().join(',');

            var FunctionGroupId = $("#add_FunctionGroup").val();

            $.ajax({
                type: "post",
                url: "/Setting/AddUser",
                data: { 'UserName': UserName, 'Name': Name, 'Password': Password, 'Role': Role, 'FunctionGroupId': FunctionGroupId },
                dataType: "json",
                success: function (data) {
                    //hideLoad();
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        HideUI('add_box');
                        GetUserList();
                        GetAddRole();
                        GetAddFunctionGroup();
                        $("#add_account").val("");
                        $("#add_name").val("");
                        $("#add_pwd").val("");
                        $("#add_role").val("").join(',');
                        $("#add_FunctionGroup").val("");

                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        });

        //列表
        function GetUserList() {
            showLoad();
            $.ajax({
                type: 'post',
                url: "/Setting/GetUserList",
                dataType: "json",
                success: function (data) {
                    hideLoad();
                    $(".rl").empty();
                    if (data.ResultType == 200) {
                        for (var i = 0; i < data.AppendData.length; i++) {
                            var row = data.AppendData[i];
                            $("#gv_data").append('<tr class="rl" id=' + row.Id + '><td><input type="checkbox" /></td><td>' + row.UserName + '</td><td>' + row.Name + '</td><td>' + row.Role + '</td><td>' + row.FunctionGroupId + '</td><td><a class="btn_channel Reset_edit modal_edit edit" data-id=' + row.Id + '>编辑</a><a class="btn_channel Reset_edit setting " data-id=' + row.Id + '>设置权限</a><a class="btn_channel Reset_remove del" data-id=' + row.Id + '>删除</a></td></tr>');
                        }
                        GetOne();
                        DelOne();
                        $(".setting").click(function () {
                            var set_id = $(this).attr("data-id");
                            window.location.href = "/Setting/SetUserFunctionRight?id=" + set_id;
                        });
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                    ErrorBox('暂无数据内容');
                }
            })

        }
        GetUserList();


        //编辑,获取一条信息
        function GetOne() {
            $(".modal_edit").click(function () {
                editID = $(this).attr("data-id");
                $("#hidden_id").val(editID);
                $.ajax({
                    type: 'post',
                    url: "/Setting/GetOneUser/" + editID,
                    dataType: "json",
                    success: function (data) {
                        if (data.ResultType == 200) {
                            var row = data.AppendData;
                            //console.log(row);
                            $("#edit_account").val(row.UserName);
                            $("#edit_name").val(row.Name);
                            $("#edit_pwd").val(row.Password);
                            $("#edit_role").val(row.Role).trigger("change");
                            $("#edit_FunctionGroup").val(row.FunctionGroupId);

                            ShowUI('edit_box');
                        }
                        else {
                            ErrorBox(data.Message);
                        }
                    }
                })
            })
        };

        //编辑  保存
        $("#btn_edit_save").click(function () {
            if (required('edit_box')) { //验证
                return false;
            }
            //showLoad();

            var id = $("#hidden_id").val();
            var UserName = $("#edit_account").val();
            var Name = $("#edit_name").val();
            var Password = $("#edit_pwd").val();
            var Role = $("#edit_role").val().join(',');
            var FunctionGroup = $("#edit_FunctionGroup").val();

            $.ajax({
                type: "post",
                url: "/Setting/UpdateUser/" + id,
                data: { 'UserName': UserName, 'Name': Name, 'Password': Password, 'Role': Role, 'FunctionGroup': FunctionGroup },
                dataType: "json",
                success: function (data) {
                    //hideLoad();
                    if (data.ResultType == 200) {
                        SuccessBox(data.Message);
                        GetUserList();
                        HideUI('edit_box');
                    }
                    else {
                        ErrorBox(data.Message);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    hideLoad();
                }
            })
        });



        //删除
        function DelOne() {
            $(".Reset_remove").click(function () {
                delID = $(this).attr("data-id");
                var r = confirm("确定删除？")

                if (r == true) {
                    showLoad();
                    $.ajax({
                        type: "post",
                        url: "/Setting/DelOneUser/" + delID,
                        dataType: "json",
                        success: function (data) {
                            hideLoad();
                            if (data.ResultType == 200) {
                                SuccessBox(data.Message);
                                GetUserList();
                            }
                            else {
                                ErrorBox(data.Message);
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            hideLoad();
                        }
                    })
                }
            })
        }






    </script>
}

